name: OptiMoldIQ CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # JOB 1: Smoke Tests (Structure only - No execution)
  # ============================================================================
  smoke-tests:
    name: ðŸš€ Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ” Find working directory
        id: find-dir
        run: |
          if [ -d "agents" ] && [ -d "tests" ]; then
            CORRECT_PATH=$(pwd)
          elif [ -d "OptiMoldIQ/agents" ] && [ -d "OptiMoldIQ/tests" ]; then
            CORRECT_PATH=$(pwd)/OptiMoldIQ
          else
            echo "Error: Cannot find project structure"
            exit 1
          fi
          echo "WORKING_DIR=$CORRECT_PATH" >> $GITHUB_ENV
          echo "working_dir=$CORRECT_PATH" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¦ Install minimal dependencies
        working-directory: ${{ steps.find-dir.outputs.working_dir }}
        run: |
          python -m pip install --upgrade pip
          pip install pytest pyyaml loguru pandas

          if [ -f requirements.txt ] && [ -s requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      - name: ðŸ§ª Smoke - Import checks
        working-directory: ${{ steps.find-dir.outputs.working_dir }}
        run: |
          export PYTHONPATH=$(pwd):$PYTHONPATH
          python -c "import agents; import modules; import configs"
      
      - name: ðŸ§ª Smoke - Structure tests (no deps)
        working-directory: ${{ steps.find-dir.outputs.working_dir }}
        run: |
          export PYTHONPATH=$(pwd):$PYTHONPATH
          pytest tests/agents_tests/test_all_agents_structure.py::TestAllAgentsStructure \
            -v --tb=short

  # ============================================================================
  # JOB 2: Module Tests (Pure units - No agents)
  # ============================================================================
  module-tests:
    name: ðŸ§© Module Tests
    runs-on: ubuntu-latest
    needs: smoke-tests
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ” Find working directory
        id: find-dir
        run: |
          if [ -d "agents" ] && [ -d "tests" ]; then
            CORRECT_PATH=$(pwd)
          elif [ -d "OptiMoldIQ/agents" ] && [ -d "OptiMoldIQ/tests" ]; then
            CORRECT_PATH=$(pwd)/OptiMoldIQ
          else
            exit 1
          fi
          echo "WORKING_DIR=$CORRECT_PATH" >> $GITHUB_ENV
          echo "working_dir=$CORRECT_PATH" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¦ Install dependencies
        working-directory: ${{ steps.find-dir.outputs.working_dir }}
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-mock pyyaml loguru pandas openpyxl
          
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      - name: ðŸ§ª Run module tests (no agent deps needed)
        working-directory: ${{ steps.find-dir.outputs.working_dir }}
        run: |
          export PYTHONPATH=$(pwd):$PYTHONPATH
          pytest tests/modules_tests/ \
            -v --tb=short \
            -m "not integration and not requires_agent" \
            --cov=modules \
            --cov-report=xml \
            --cov-report=term-missing
      
      - name: ðŸ“Š Upload module coverage
        uses: codecov/codecov-action@v3
        with:
          file: ${{ steps.find-dir.outputs.working_dir }}/coverage.xml
          flags: modules
          name: module-coverage

  # ============================================================================
  # JOB 3: Agent Tests (Self-managing dependencies via fixtures)
  # ============================================================================
  
  agent-tests:
    name: ðŸ¤– Agent Tests
    runs-on: ubuntu-latest
    needs: smoke-tests
    timeout-minutes: 50  # Longer because tests trigger deps themselves

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ” Find working directory
        id: find-dir
        run: |
          if [ -d "agents" ] && [ -d "tests" ]; then
            CORRECT_PATH=$(pwd)
          elif [ -d "OptiMoldIQ/agents" ] && [ -d "OptiMoldIQ/tests" ]; then
            CORRECT_PATH=$(pwd)/OptiMoldIQ
          else
            echo "Error: Cannot find project structure"
            exit 1
          fi
          echo "WORKING_DIR=$CORRECT_PATH" >> $GITHUB_ENV
          echo "working_dir=$CORRECT_PATH" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Install dependencies
        working-directory: ${{ steps.find-dir.outputs.working_dir }}
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pyyaml loguru
          
          if [ -f requirements.txt ] && [ -s requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      # â„¹ï¸ NO MANUAL SETUP - Tests trigger deps via dependency_provider fixture!
      
      - name: ðŸ§ª Run agent tests (dependencies auto-triggered)
        working-directory: ${{ steps.find-dir.outputs.working_dir }}
        run: |
          export PYTHONPATH=$(pwd):$PYTHONPATH
          
          # Run all agent tests
          # - TestAllAgentsExecution: triggers deps via create_and_execute()
          # - Specific agent tests: trigger deps via dependency_provider.trigger()
          pytest tests/agents_tests/ \
            -v --tb=short \
            --cov=agents \
            --cov-report=xml \
            --cov-report=term-missing \
            --maxfail=5
      
      - name: ðŸ“Š Upload agent coverage
        uses: codecov/codecov-action@v3
        with:
          file: ${{ steps.find-dir.outputs.working_dir }}/coverage.xml
          flags: agents
          name: agent-coverage

      - name: ðŸ’¾ Archive test artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: agent-test-artifacts
          path: |
            ${{ steps.find-dir.outputs.working_dir }}/tests/shared_db/
            ${{ steps.find-dir.outputs.working_dir }}/logs/
          retention-days: 7

  # ============================================================================
  # JOB 4: Integration Tests (Module + Agent)
  # ============================================================================
  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [module-tests, agent-tests]
    timeout-minutes: 20
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ” Find working directory
        id: find-dir
        run: |
          if [ -d "agents" ] && [ -d "tests" ]; then
            CORRECT_PATH=$(pwd)
          elif [ -d "OptiMoldIQ/agents" ] && [ -d "OptiMoldIQ/tests" ]; then
            CORRECT_PATH=$(pwd)/OptiMoldIQ
          else
            exit 1
          fi
          echo "WORKING_DIR=$CORRECT_PATH" >> $GITHUB_ENV
          echo "working_dir=$CORRECT_PATH" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¦ Install dependencies
        working-directory: ${{ steps.find-dir.outputs.working_dir }}
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pyyaml loguru
          
          if [ -f requirements.txt ] && [ -s requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      - name: ðŸ§¹ Cleanup shared_db
        working-directory: ${{ steps.find-dir.outputs.working_dir }}
        run: |
          rm -rf tests/shared_db
      
      - name: âš™ï¸ Setup shared_db
        working-directory: ${{ steps.find-dir.outputs.working_dir }}
        run: |
          export PYTHONPATH=$(pwd):$PYTHONPATH
          pytest tests/set_up_shared_db/setup_shared_db.py -v
      
      - name: ðŸ§ª Run integration tests
        working-directory: ${{ steps.find-dir.outputs.working_dir }}
        run: |
          export PYTHONPATH=$(pwd):$PYTHONPATH
          
          # Module tests that require agents
          pytest tests/modules_tests/ \
            -v --tb=short \
            -m "integration or requires_agent" \
            --cov=modules \
            --cov-report=xml \
            --cov-report=term-missing
      
      - name: ðŸ“Š Upload integration coverage
        uses: codecov/codecov-action@v3
        with:
          file: ${{ steps.find-dir.outputs.working_dir }}/coverage.xml
          flags: integration
          name: integration-coverage

  # ============================================================================
  # JOB 5: Summary Report
  # ============================================================================
  report:
    name: ðŸ“Š Test Report
    runs-on: ubuntu-latest
    needs: [smoke-tests, module-tests, agent-tests, integration-tests]
    if: always()
    
    steps:
      - name: ðŸ“‹ Generate Summary
        run: |
          echo "## ðŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Smoke Tests | ${{ needs.smoke-tests.result }} | ~5 min |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§© Module Tests | ${{ needs.module-tests.result }} | ~10 min |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ¤– Agent Tests | ${{ needs.agent-tests.result }} | ~50 min |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Integration Tests | ${{ needs.integration-tests.result }} | ~20 min |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [[ "${{ needs.smoke-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.module-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.agent-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
            echo "### âŒ Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Review failed job logs above" >> $GITHUB_STEP_SUMMARY
            echo "2. Check test artifacts (if uploaded)" >> $GITHUB_STEP_SUMMARY
            echo "3. Run locally: \`pytest tests/agents_tests/ -v\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "### âœ… All Tests Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Coverage Reports:** Available in Codecov" >> $GITHUB_STEP_SUMMARY
          fi